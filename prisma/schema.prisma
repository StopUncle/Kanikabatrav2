generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String            @id @default(cuid())
  email     String            @unique
  password  String
  name      String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  sessions  CoachingSession[]
  purchases Purchase[]

  @@index([email])
}

model Purchase {
  id              String            @id @default(cuid())
  userId          String?
  type            ProductType
  productVariant  String?
  customerEmail   String
  customerName    String
  amount          Float
  status          PurchaseStatus    @default(PENDING)
  paypalOrderId   String?           @unique
  paypalCaptureId String?
  downloadToken   String?           @unique
  downloadCount   Int               @default(0)
  maxDownloads    Int               @default(5)
  lastDownloadAt  DateTime?
  expiresAt       DateTime?
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  sessions        CoachingSession[]
  user            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paypalOrderId])
  @@index([customerEmail])
  @@index([downloadToken])
}

model CoachingSession {
  id           String        @id @default(cuid())
  purchaseId   String
  userId       String?
  packageName  String
  sessionCount Int           @default(1)
  scheduledAt  DateTime?
  duration     Int?
  status       SessionStatus @default(PENDING_SCHEDULING)
  meetingUrl   String?
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  purchase     Purchase      @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([purchaseId])
  @@index([scheduledAt])
}

enum ProductType {
  BOOK
  COURSE
  COACHING
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SessionType {
  INDIVIDUAL
  GROUP
  VIP
}

enum SessionStatus {
  PENDING_SCHEDULING
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}
